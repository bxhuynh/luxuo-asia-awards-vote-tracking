<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Analytics - Tóc Tiên</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg-body: #0a0c10;
        --bg-card: #161b22;
        --border: #30363d;
        --toc-tien: #ff2d55;
        --ky-duyen: #58a6ff;
        --lan-ngoc: #f2cc60;
        --text-main: #c9d1d9;
        --text-bright: #ffffff;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        background: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: auto;
      }

      /* Banner kêu gọi bình chọn */
      .cta-banner {
        background: linear-gradient(
          90deg,
          rgba(255, 45, 85, 0.2) 0%,
          rgba(22, 27, 34, 1) 100%
        );
        border: 1px solid var(--toc-tien);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 0 20px rgba(255, 45, 85, 0.15);
      }
      .cta-content h2 {
        margin: 0;
        color: #fff;
        font-size: 1.4rem;
      }
      .cta-content p {
        margin: 8px 0 0;
        color: var(--text-main);
        font-size: 0.95rem;
      }
      .btn-vote {
        background: var(--toc-tien);
        color: white;
        text-decoration: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 700;
        transition: all 0.3s ease;
        white-space: nowrap;
        box-shadow: 0 4px 15px rgba(255, 45, 85, 0.4);
      }
      .btn-vote:hover {
        transform: scale(1.05);
        filter: brightness(1.2);
      }

      /* Widget Stats */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }
      .widget {
        background: var(--bg-card);
        border: 1px solid var(--border);
        padding: 20px;
        border-radius: 12px;
      }
      .widget-label {
        font-size: 12px;
        font-weight: 600;
        color: #8b949e;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .widget-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-bright);
        margin: 10px 0;
      }
      .widget-footer {
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .trend-up {
        color: #3fb950;
        font-weight: bold;
      }

      /* Layout Charts */
      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      /* Table Style */
      .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
        font-size: 14px;
      }
      th {
        background: #21262d;
        padding: 15px;
        color: #8b949e;
        font-weight: 500;
      }
      td {
        padding: 15px;
        border-top: 1px solid var(--border);
      }
      .name-cell {
        font-weight: 600;
        color: var(--text-bright);
      }
      .delta-cell {
        font-size: 12px;
        color: #3fb950;
      }
      tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .highlight-row {
        background: rgba(255, 45, 85, 0.05);
      }

      @media (max-width: 900px) {
        .cta-banner {
          flex-direction: column;
          text-align: center;
          gap: 20px;
        }
        .main-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
    <div class="container">
      <div
        style="
          margin-bottom: 30px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <div>
          <h1 style="color: var(--text-bright); margin: 0">
            LUXUO ASIA AWARDS 2025
          </h1>
          <p
            id="update-info"
            style="color: #8b949e; font-size: 14px; margin: 5px 0 0"
          ></p>
        </div>
        <div
          style="
            font-size: 12px;
            background: #21262d;
            padding: 5px 12px;
            border-radius: 20px;
            color: var(--toc-tien);
          "
        >
          ● LIVE TRACKING
        </div>
      </div>

      <div class="cta-banner">
        <div class="cta-content">
          <h2>Ủng hộ Ca sĩ Tóc Tiên</h2>
          <p>
            Tham gia hành trình chinh phục LUXUO ASIA AWARDS 2025 ngay hôm nay!
          </p>
        </div>
        <a
          href="https://luxuoasiaawards2025.1vote.vn/thi-sinh/dwdyc/ca-si-toc-tien-fNK9"
          target="_blank"
          class="btn-vote"
        >
          BÌNH CHỌN NGAY ↗
        </a>
      </div>

      <div class="stats-grid" id="stat-widgets"></div>

      <div class="main-grid">
        <div class="widget">
          <div class="widget-label">Xu hướng thay đổi tổng lượt vote</div>
          <canvas id="mainChart" height="150"></canvas>
        </div>
        <div class="widget">
          <div class="widget-label">Phân bổ tăng trưởng mới nhất</div>
          <canvas id="pieChart"></canvas>
        </div>
      </div>

      <div class="widget-label" style="margin-bottom: 10px">
        Lịch sử thay đổi chi tiết
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Thời gian</th>
              <th>Tên ứng viên</th>
              <th>Tổng Vote</th>
              <th>Tăng (15p)</th>
              <th>Trạng thái</th>
            </tr>
          </thead>
          <tbody id="comparison-table"></tbody>
        </table>
      </div>
    </div>

    <script>
      const COLORS = {
        'Ca sĩ Tóc Tiên': '#ff2d55',
        'Diễn viên Nguyễn Cao Kỳ Duyên': '#58a6ff',
        'Diễn viên Ninh Dương Lan Ngọc': '#f2cc60',
      };

      async function fetchData() {
        try {
          const res = await fetch(`data.json?t=${new Date().getTime()}`);
          const data = await res.json();
          render(data);
        } catch (e) {
          console.error('Không thể tải dữ liệu', e);
        }
      }

      function render(data) {
        if (!data || data.length === 0) return;
        const latest = data[data.length - 1];
        const names = Object.keys(latest.votes);

        document.getElementById(
          'update-info'
        ).innerText = `Dữ liệu đồng bộ lần cuối: ${latest.time}`;

        // 1. Render Widgets
        const widgetContainer = document.getElementById('stat-widgets');
        widgetContainer.innerHTML = names
          .map(
            (name) => `
            <div class="widget" style="border-top: 3px solid ${COLORS[name]}">
                <div class="widget-label">${name}</div>
                <div class="widget-value">${latest.votes[
                  name
                ].toLocaleString()}</div>
                <div class="widget-footer">
                    <span class="trend-up">▲ +${latest.increase[
                      name
                    ].toLocaleString()}</span> 
                    <span style="color: #8b949e">từ 15p trước</span>
                </div>
            </div>
        `
          )
          .join('');

        // 2. Render Table
        const tableBody = document.getElementById('comparison-table');
        const displayData = data.slice(-5).reverse();
        let tableHtml = '';
        displayData.forEach((entry) => {
          names.forEach((name, idx) => {
            const isTocTien = name.includes('Tóc Tiên');
            tableHtml += `
                    <tr class="${isTocTien ? 'highlight-row' : ''}">
                        ${
                          idx === 0
                            ? `<td rowspan="${names.length}" style="vertical-align:top; color:#8b949e; border-right: 1px solid var(--border)">${entry.time}</td>`
                            : ''
                        }
                        <td class="name-cell" style="color: ${
                          COLORS[name]
                        }">${name}</td>
                        <td>${entry.votes[name].toLocaleString()}</td>
                        <td class="delta-cell">+${entry.increase[
                          name
                        ].toLocaleString()}</td>
                        <td><span style="color: ${
                          entry.increase[name] > 0 ? '#3fb950' : '#8b949e'
                        }">● ${
              entry.increase[name] > 0 ? 'Active' : 'Stable'
            }</span></td>
                    </tr>
                `;
          });
        });
        tableBody.innerHTML = tableHtml;

        // 3. Render Chart
        Chart.defaults.color = '#8b949e';
        new Chart(document.getElementById('mainChart'), {
          type: 'line',
          data: {
            labels: data.map((d) => d.time),
            datasets: names.map((name) => ({
              label: name,
              data: data.map((d) => d.votes[name]),
              borderColor: COLORS[name],
              backgroundColor: name.includes('Tóc Tiên')
                ? 'rgba(255, 45, 85, 0.1)'
                : 'transparent',
              tension: 0.3,
              pointRadius: 2,
              fill: name.includes('Tóc Tiên'),
              borderWidth: name.includes('Tóc Tiên') ? 4 : 2,
            })),
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              y: { grid: { color: '#21262d' }, ticks: { font: { size: 10 } } },
              x: { grid: { display: false }, ticks: { font: { size: 10 } } },
            },
          },
        });

        // 4. Pie Chart
        new Chart(document.getElementById('pieChart'), {
          type: 'doughnut',
          data: {
            labels: names.map((n) => n.split(' ').pop()),
            datasets: [
              {
                data: names.map((n) => latest.increase[n] || 0),
                backgroundColor: names.map((n) => COLORS[n]),
                borderWidth: 0,
              },
            ],
          },
          options: {
            cutout: '80%',
            plugins: { legend: { position: 'bottom' } },
          },
        });
      }

      fetchData();
      // Tự động cập nhật mỗi 5 phút mà không cần tải lại trang
      setInterval(fetchData, 300000);
    </script>
  </body>
</html>
