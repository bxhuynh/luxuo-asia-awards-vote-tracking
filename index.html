<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Analytics Report - Tóc Tiên</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg-body: #0a0c10;
        --bg-card: #161b22;
        --border: #30363d;
        --toc-tien: #ff2d55;
        --ky-duyen: #58a6ff;
        --lan-ngoc: #f2cc60;
        --text-main: #c9d1d9;
        --text-bright: #ffffff;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        background: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: auto;
      }

      /* Header */
      header {
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .live-tag {
        font-size: 11px;
        background: rgba(255, 45, 85, 0.1);
        padding: 4px 12px;
        border-radius: 20px;
        color: var(--toc-tien);
        font-weight: bold;
        border: 1px solid var(--toc-tien);
      }

      /* CTA Banner */
      .cta-banner {
        background: linear-gradient(
          90deg,
          rgba(255, 45, 85, 0.15) 0%,
          rgba(22, 27, 34, 1) 100%
        );
        border: 1px solid var(--toc-tien);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cta-content h2 {
        margin: 0;
        color: #fff;
        font-size: 1.4rem;
      }
      .btn-vote {
        background: var(--toc-tien);
        color: white;
        text-decoration: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 700;
        transition: 0.3s;
        box-shadow: 0 4px 15px rgba(255, 45, 85, 0.3);
      }
      .btn-vote:hover {
        transform: scale(1.05);
        filter: brightness(1.2);
      }

      /* Widgets */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }
      .widget {
        background: var(--bg-card);
        border: 1px solid var(--border);
        padding: 20px;
        border-radius: 12px;
      }
      .widget-label {
        font-size: 12px;
        color: #8b949e;
        text-transform: uppercase;
      }
      .widget-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-bright);
        margin: 10px 0;
      }
      .trend-up {
        color: #3fb950;
        font-weight: bold;
        font-size: 14px;
      }

      /* Charts */
      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      /* Table */
      .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th {
        background: #21262d;
        padding: 15px;
        text-align: left;
        color: #8b949e;
      }
      td {
        padding: 15px;
        border-top: 1px solid var(--border);
      }
      .highlight-row {
        background: rgba(255, 45, 85, 0.05);
      }

      @media (max-width: 900px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
        .cta-banner {
          flex-direction: column;
          text-align: center;
          gap: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1 style="color: var(--text-bright); margin: 0">
            LUXUO ASIA AWARDS 2025
          </h1>
          <p
            id="update-info"
            style="color: #8b949e; font-size: 13px; margin-top: 5px"
          >
            Đang tải dữ liệu...
          </p>
        </div>
        <div class="live-tag">● LIVE TRACKING</div>
      </header>

      <div class="cta-banner">
        <div class="cta-content">
          <h2>Ủng hộ Ca sĩ Tóc Tiên</h2>
          <p>
            Bình chọn ngay để tiếp sức cho Tóc Tiên trong hành trình năm nay!
          </p>
        </div>
        <a
          href="https://luxuoasiaawards2025.1vote.vn/thi-sinh/dwdyc/ca-si-toc-tien-fNK9"
          target="_blank"
          class="btn-vote"
          >BÌNH CHỌN NGAY ↗</a
        >
      </div>

      <div class="stats-grid" id="stat-widgets"></div>

      <div class="main-grid">
        <div class="widget">
          <div class="widget-label">Xu hướng Vote</div>
          <canvas id="mainChart" height="150"></canvas>
        </div>
        <div class="widget">
          <div class="widget-label">Cơ cấu tăng trưởng 15p gần nhất</div>
          <canvas id="pieChart"></canvas>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Thời gian</th>
              <th>Ứng viên</th>
              <th>Tổng Vote</th>
              <th>Tăng (15p)</th>
            </tr>
          </thead>
          <tbody id="comparison-table"></tbody>
        </table>
      </div>
    </div>

    <script>
      const COLORS = {
        'Ca sĩ Tóc Tiên': '#ff2d55',
        'Diễn viên Nguyễn Cao Kỳ Duyên': '#58a6ff',
        'Diễn viên Ninh Dương Lan Ngọc': '#f2cc60',
      };

      // Khai báo instance toàn cục để tránh lỗi "Canvas in use"
      let mainChartInstance = null;
      let pieChartInstance = null;

      async function fetchData() {
        try {
          // Thêm timestamp để phá cache trình duyệt
          const res = await fetch(`data.json?t=${new Date().getTime()}`);
          const data = await res.json();
          if (data && data.length > 0) render(data);
        } catch (e) {
          console.error('Lỗi tải dữ liệu:', e);
        }
      }

      function render(data) {
        const latest = data[data.length - 1];
        const names = Object.keys(latest.votes);

        document.getElementById(
          'update-info'
        ).innerText = `Đồng bộ (Giờ VN): ${latest.time}`;

        // 1. Cập nhật Widgets
        const widgetContainer = document.getElementById('stat-widgets');
        widgetContainer.innerHTML = names
          .map(
            (name) => `
            <div class="widget" style="border-top: 3px solid ${COLORS[name]}">
                <div class="widget-label">${name}</div>
                <div class="widget-value">${latest.votes[
                  name
                ].toLocaleString()}</div>
                <div class="trend-up">▲ +${latest.increase[
                  name
                ].toLocaleString()}</div>
            </div>
        `
          )
          .join('');

        // 2. Vẽ lại Biểu đồ đường
        const ctxMain = document.getElementById('mainChart').getContext('2d');
        if (mainChartInstance) mainChartInstance.destroy(); // Hủy biểu đồ cũ

        mainChartInstance = new Chart(ctxMain, {
          type: 'line',
          data: {
            labels: data.map((d) => d.time),
            datasets: names.map((name) => ({
              label: name.split(' ').pop(),
              data: data.map((d) => d.votes[name]),
              borderColor: COLORS[name],
              tension: 0.3,
              pointRadius: 2,
              borderWidth: name.includes('Tóc Tiên') ? 4 : 2,
              fill: name.includes('Tóc Tiên'),
              backgroundColor: name.includes('Tóc Tiên')
                ? 'rgba(255, 45, 85, 0.1)'
                : 'transparent',
            })),
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { grid: { color: '#21262d' } },
              x: { grid: { display: false } },
            },
          },
        });

        // 3. Vẽ lại Biểu đồ tròn
        const ctxPie = document.getElementById('pieChart').getContext('2d');
        if (pieChartInstance) pieChartInstance.destroy(); // Hủy biểu đồ cũ

        pieChartInstance = new Chart(ctxPie, {
          type: 'doughnut',
          data: {
            labels: names.map((n) => n.split(' ').pop()),
            datasets: [
              {
                data: names.map((n) => latest.increase[n] || 0),
                backgroundColor: names.map((n) => COLORS[n]),
                borderWidth: 0,
              },
            ],
          },
          options: {
            cutout: '80%',
            plugins: { legend: { position: 'bottom' } },
          },
        });

        // 4. Cập nhật Bảng (5 mốc gần nhất)
        const tableBody = document.getElementById('comparison-table');
        const recentData = data.slice(-5).reverse();
        let tableHtml = '';
        recentData.forEach((entry) => {
          names.forEach((name, idx) => {
            const isTT = name.includes('Tóc Tiên');
            tableHtml += `
                    <tr class="${isTT ? 'highlight-row' : ''}">
                        ${
                          idx === 0
                            ? `<td rowspan="${names.length}" style="color:#8b949e; border-right: 1px solid var(--border)">${entry.time}</td>`
                            : ''
                        }
                        <td style="font-weight:600; color:${
                          COLORS[name]
                        }">${name}</td>
                        <td>${entry.votes[name].toLocaleString()}</td>
                        <td style="color:#3fb950; font-weight:bold">+${entry.increase[
                          name
                        ].toLocaleString()}</td>
                    </tr>
                `;
          });
        });
        tableBody.innerHTML = tableHtml;
      }

      // Khởi chạy
      fetchData();
      // Tự động tải lại mỗi 5 phút (300.000 ms)
      setInterval(fetchData, 5 * 60 * 1000);
    </script>
  </body>
</html>
